'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

const utils = require('unplugin-transform-class/utils');
const core = require('@unocss/core');
require('./shared/unocss-preset-weapp.41ef2805.cjs');
const colors$1 = require('./shared/unocss-preset-weapp.80bd545b.cjs');
const _default$1 = require('./shared/unocss-preset-weapp.0342cae8.cjs');
const colors = require('./shared/unocss-preset-weapp.37d5deb4.cjs');
const _default = require('./shared/unocss-preset-weapp.57bf3e1d.cjs');
const _default$2 = require('./shared/unocss-preset-weapp.4c6357e3.cjs');
require('./shared/unocss-preset-weapp.60967b4e.cjs');

const wxPrefix = "page";
const taroPrefix = "*";
const uniappPrefix = "uni-page-body";
function preflights(isH5, platform) {
  return [
    {
      layer: "preflights",
      getCSS(ctx) {
        if (ctx.theme.preflightBase) {
          const css = core.entriesToCss(Object.entries(ctx.theme.preflightBase));
          const preflights = `,::before,::after{${css}}::backdrop{${css}}`;
          if (isH5)
            return `${platform === "uniapp" ? uniappPrefix : taroPrefix}${preflights}`;
          else
            return `${wxPrefix}${preflights}`;
        }
      }
    }
  ];
}

function taroPxToRpx(size, designWidth, deviceRatio) {
  if (!(designWidth in deviceRatio))
    throw new Error(`deviceRatio \u914D\u7F6E\u4E2D\u4E0D\u5B58\u5728 ${designWidth} \u7684\u8BBE\u7F6E\uFF01`);
  return `${parseInt(size, 10) * deviceRatio[designWidth]}rpx`;
}
function taroRpxToPx(size, designWidth, deviceRatio) {
  if (!(designWidth in deviceRatio))
    throw new Error(`deviceRatio \u914D\u7F6E\u4E2D\u4E0D\u5B58\u5728 ${designWidth} \u7684\u8BBE\u7F6E\uFF01`);
  return parseInt(size, 10) / deviceRatio[designWidth];
}
function taroPxToRemW4(size, designWidth) {
  return `${Math.ceil(parseInt(size, 10) / 40 * 640 / designWidth * 1e5) / 1e5}rem`;
}
function taroPxToRemW5(size, designWidth, deviceRatio) {
  const baseFontSize = 20;
  const unitPrecision = 5;
  const rootValue = baseFontSize / deviceRatio[designWidth] * 2;
  const pixels = parseFloat(size);
  return `${toFixed(pixels / rootValue, unitPrecision)}rem`;
}
function toFixed(number, precision) {
  const multiplier = 10 ** (precision + 1);
  const wholeNumber = Math.floor(number * multiplier);
  return Math.round(wholeNumber / 10) * 10 / multiplier;
}

function uniAppRpxTransform(size) {
  return `%?${size}?%`;
}

const pxRE = /^-?[\.\d]+px$/;
const rpxRE = /^-?[\.\d]+rpx$/;
const rpxOrPxRE = /^-?[\.\d]+r?px$/;
const presetWeapp = (options = {}) => {
  options.dark = options.dark ?? "class";
  options.attributifyPseudo = options.attributifyPseudo ?? false;
  options.transform = options.transform ?? true;
  options.isH5 = options.isH5 ?? false;
  options.designWidth = options.designWidth ?? 750;
  options.deviceRatio = options.deviceRatio ?? {
    640: 2.34 / 2,
    750: 1,
    828: 1.81 / 2
  };
  options.platform = options.platform ?? "uniapp";
  options.taroWebpack = options.taroWebpack ?? "webpack4";
  options.transformRules = options.transformRules ?? utils.defaultRules;
  return {
    name: "unocss-preset-weapp",
    theme: {
      ..._default.theme,
      transformRules: options.transformRules
    },
    rules: _default$1.rules,
    variants: _default$2.variants(options),
    options,
    postprocess(css) {
      if (options.transform)
        css.selector = utils.transformEscapESelector(css.selector, options.transformRules);
      if (options.variablePrefix && options.variablePrefix !== "un-")
        VarPrefixPostprocessor(options.variablePrefix, css);
      if (options.platform === "taro") {
        if (options.isH5) {
          cssRpxTransform(
            css,
            (value) => {
              return rpxOrPxRE.test(value);
            },
            (value) => {
              const size = value.endsWith("rpx") ? taroRpxToPx(value.slice(0, -3), options.designWidth, options.deviceRatio) : value.slice(0, -2);
              return options.taroWebpack === "webpack4" ? taroPxToRemW4(size, options.designWidth) : taroPxToRemW5(size, options.designWidth, options.deviceRatio);
            }
          );
        } else {
          cssRpxTransform(
            css,
            (value) => {
              return pxRE.test(value);
            },
            (value) => {
              return taroPxToRpx(value.slice(0, -2), options.designWidth, options.deviceRatio);
            }
          );
        }
      }
      if (options.platform === "uniapp" && options.isH5) {
        css.entries.forEach((i) => {
          const value = i[1];
          if (value && typeof value === "string" && rpxRE.test(value))
            i[1] = `${uniAppRpxTransform(value.slice(0, -3))}`;
        });
      }
    },
    preflights: preflights(options.isH5, options.platform),
    prefix: options.prefix
  };
};
function VarPrefixPostprocessor(prefix, obj) {
  obj.entries.forEach((i) => {
    i[0] = i[0].replace(/^--un-/, `--${prefix}`);
    if (typeof i[1] === "string")
      i[1] = i[1].replace(/var\(--un-/g, `var(--${prefix}`);
  });
}
function cssRpxTransform(css, condition, transform) {
  css.entries.forEach((i) => {
    const value = i[1];
    if (value && typeof value === "string" && condition(value))
      i[1] = `${transform(value)}`;
  });
}

exports.parseColor = colors$1.parseColor;
exports.colors = colors.colors;
exports.theme = _default.theme;
exports["default"] = presetWeapp;
exports.presetWeapp = presetWeapp;
exports.pxRE = pxRE;
exports.rpxOrPxRE = rpxOrPxRE;
exports.rpxRE = rpxRE;
